# Deploying the App
Our app targets the web platform and the native iOS and Android platforms. That means, from our common source code we are able to generate a webapp (served from loconomics.com), a native iOS app and a native Android app.

We use [Phonegap](http://phonegap.com/) to build the iOS and Android apps to later be uploaded to their respective stores.

## Phonegap Build Service
We use the [Phonegap Build](https://build.phonegap.com/) service to build the app for iOS and Android in the cloud.

This is our preferred way, both to generate the production version of the app ('live' channel) and testing versions when some debugging in actual devices is needed (working against 'dev' or 'testing' channels).

To build for the build service,

```bash
grunt build

grunt prepare-phonegapbuild-dev # for a dev/test build

# or

grunt prepare-phonegapbuild-live # for a production build
```

The ``prepare-*`` tasks generate zip files under /build directory, one for each task, that can be uploaded to the Phonegap Build service.

## Phonegap cli
The Phonegap cli can be used to build the app locally on a developer machine. It's more complex, has lot of requirements and may throw platform-specific errors.

Start by installing the tools from npm (may require elevated privileges, like 'su root' on \*nix machines):
```bash
npm install -g phonegap
```
The project has a folder ready to store results of a local build, but most files there are ignored by git: the /app/phonegap folder.

### Preparing Phonegap Build

To prepare for a phonegap build,

```bash
grunt build

grunt prepare-phonegapcli-dev # for testing

# or

grunt prepare-phonegapcli-live # for production
```

This ``prepare-*`` tasks performs additional build on top of ``grunt build``, like
generate Phonegap config files based on templates and package.json, and copy resources.

**Note** In recent versions of the Phonegap cli all plugins are detected from config and installed automatically. But in previous versions, Phonegap plugins used by the project must be installed before building; they are listed at the generated config.xml file and are fetched from npm or git repositories.

On previous versions, or to test some plugin without add it still to the project source, you can install each plugin individually with next command (is an example where the URL must be replaced by the plugin git repository):
```
phonegap plugin add https://git-wip-us.apache.org/repos/asf/cordova-plugin-inappbrowser.git
```

**Important:**: do **not** modify the /app/phonegap/www/config.xml file manually, as already commented is autogenerated (for example, if you need to add a plugin, do not add it there and do not add it using 'phonegap plugin add xx **--save**'). You must add a plugin line at the file /app/source/cordova-config.js.xml (look at the *plugin* elements), set a specific version and run any of the 'grunt prepare-phonegapcli-*' tasks. Remember that the PhoneGap Build service use this list of plugins to automatically install them too (and the whole file, for any setup), so any addition must be compatible (check docs or ask teammates for advice).

### Platform SDKs

You will need the **SDKs** of each platform you want to build for.

#### iOS
[Download and install Apple XCode](https://itunes.apple.com/us/app/xcode/id497799835?mt=12) and run the command:
```bash
phonegap build ios
```

#### Android

1. Install a recent version of JDK (in Ubuntu Linux, ``openjdk-8-jdk`` for example).
2. [Download and install Android Studio](https://developer.android.com/studio/index.html). Depending on your OS, you may need to add ANDROID_HOME to your environment variables. Check with @iagoSRL to determine which version of the Android API you need to install. As of this writing it's API level 24.
3. Build the APK:
```bash
cd app/phonegap
phonegap build android
```
The APK file will be built at ``app/phonegap/platforms/android/build/outputs/apk/``.

## Phonegap tasks summary
**grunt prepare-phonegap?-? tasks**
- The `*cli-` tasks prepare the /phonegap folder to build locally using `phonegap` or `cordoba`
command line tools, having the SDKs for the target system (Android, iOS).
- The `*build-` tasks prepare the /phonegap folder and creates a **zip file** under /build folder, that can be uploaded to the
PhoneGap Build service to build the native apps.
- The `-dev` tasks uses files meant for debugging (not minified, with source maps) and pointing to the *dev* site URL.
(An html data-site-url with http://dev.loconomics.co)
- The `-live` tasks uses files meant for production (minified, optimized) and pointing to the *live* site URL.
(An html data-site-url with https://loconomics.com)

## Web
In terminal enter command:
```
grunt build-webapp
```
that will build the html, and build/copy assets (js, css, images, fonts).

If assets are already generated, you can build only the html:
```
grunt build-webapp-html
```

The output files for that tasks goes to the /web directory; in a local environment with the [back-end setup done](Backend Development Environment Setup Guide.md), you can just try it at your localhost dev server.
To update a remote webserver, upload the following files via FTP from your local machine:
- web/_specialRoutes/app.html (single file)
- web/assets (all folder contents)
